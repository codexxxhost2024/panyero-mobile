<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- Mobile-first, disable zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panyero Wallet - Home</title>
    <link rel="apple-touch-icon" href="assets/images/logo/panyero.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        :root {
            --primary-color: #18385e;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f5f5f5;
        }
    </style>
</head>

<body class="bg-gray-100 flex flex-col mx-auto min-h-screen max-w-sm w-full">
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDTsjYZNWFfZOESP-2QQfbD7jc5fG9FJdc",
            authDomain: "explore-malaysia-6d28d.firebaseapp.com",
            projectId: "explore-malaysia-6d28d",
            storageBucket: "explore-malaysia-6d28d.appspot.com",
            messagingSenderId: "869053244601",
            appId: "1:869053244601:web:29ad09ff454b43230be768",
            measurementId: "G-5XJK1H7KWX"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <!-- Header -->
    <header
        class="bg-primary text-white p-4 text-lg font-semibold flex items-center justify-between sticky top-0 z-50">
        <div class="flex items-center space-x-2">
            <div class="w-28 h-11 bg-no-repeat bg-center bg-contain"
                style="background-image: url('assets/images/logo/logo.png')"></div>
        </div>
        <div class="flex items-center space-x-4">
            <div class="relative cursor-pointer" onclick="handleNotificationClick()">
                <span class="material-icons text-2xl">notifications</span>
                <span id="notificationBadge"
                    class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 hidden">0</span>
            </div>
            <span class="material-icons text-2xl cursor-pointer" id="logoutBtn">logout</span>
        </div>
    </header>

    <!-- Top Nav -->
    <nav class="bg-white flex space-x-8 overflow-x-auto border-b border-gray-300 p-2 text-sm font-semibold h-16">
        <a href="index.html" class="active text-gray-700 border-b-4 border-green-500 pb-1">Wallet</a>
        <a href="subscription.html" class="text-gray-500">Subscribe</a>
        <a href="credit.html" class="text-gray-500">Credit</a>
        <a href="loans.html" class="text-gray-500">Loans</a>
        <a href="cards.html" class="text-gray-500">Cards</a>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col items-center p-4 w-full overflow-y-auto pb-24 space-y-4">
        <!-- Wallet Balance Block -->
        <div class="bg-white rounded-lg p-4 shadow w-full relative">
            <div class="flex items-center justify-between mb-3">
                <div id="userName" class="text-xs font-semibold text-gray-800"></div>
                <div id="userMobile" class="text-xs text-gray-500"></div>
            </div>

            <div class="flex items-center justify-between">
                <div>
                    <div id="balanceAmount" class="text-2xl font-bold text-black">â‚±0</div>
                    <div class="text-sm text-gray-600">Available balance</div>
                </div>
                <span class="material-icons text-xl text-gray-500 cursor-pointer" id="toggleBalanceBtn">
                    visibility
                </span>
            </div>

            <div class="flex space-x-4 w-full mt-3">
                <button onclick="window.location.href='cashin.html'"
                    class="flex-1 bg-primary text-white py-2 rounded font-medium hover:bg-primary-dark transition-colors">
                    Cash In
                </button>
                <button onclick="window.location.href='transfer.html'"
                    class="flex-1 bg-primary text-white py-2 rounded font-medium hover:bg-primary-dark transition-colors">
                    Transfer
                </button>
            </div>
        </div>

        <!-- 4 New Icons (Persona, Apps, Affiliate, Earn) -->
        <div class="grid grid-cols-4 gap-3 w-full">
            <div class="bg-white rounded-lg shadow flex flex-col items-center p-2 cursor-pointer transform hover:scale-110 transition-transform duration-200"
                onclick="window.location.href='persona.html'">
                <span
                    class="material-icons bg-gray-200 rounded-md w-8 h-8 flex items-center justify-center text-gray-700 mb-1 text-base" style="font-size: 1.5em">
                    person
                </span>
                <div class="text-xs font-semibold text-gray-600">Persona</div>
            </div>
            <div class="bg-white rounded-lg shadow flex flex-col items-center p-2 cursor-pointer transform hover:scale-110 transition-transform duration-200"
                onclick="window.location.href='apps.html'">
                <span
                    class="material-icons bg-gray-200 rounded-md w-8 h-8 flex items-center justify-center text-gray-700 mb-1 text-base" style="font-size: 1.5em">
                    apps
                </span>
                <div class="text-xs font-semibold text-gray-600">Apps</div>
            </div>
            <div class="bg-white rounded-lg shadow flex flex-col items-center p-2 cursor-pointer transform hover:scale-110 transition-transform duration-200"
                onclick="window.location.href='affiliate.html'">
                <span
                    class="material-icons bg-gray-200 rounded-md w-8 h-8 flex items-center justify-center text-gray-700 mb-1 text-base" style="font-size: 1.5em">
                    groups
                </span>
                <div class="text-xs font-semibold text-gray-600">Affiliate</div>
            </div>
            <div class="bg-white rounded-lg shadow flex flex-col items-center p-2 cursor-pointer transform hover:scale-110 transition-transform duration-200"
                onclick="window.location.href='earn.html'">
                <span
                    class="material-icons bg-gray-200 rounded-md w-8 h-8 flex items-center justify-center text-gray-700 mb-1 text-base" style="font-size: 1.5em">
                    monetization_on
                </span>
                <div class="text-xs font-semibold text-gray-600">Earn</div>
            </div>
        </div>

        <!-- 8 Existing Icons -->
        <div class="grid grid-cols-4 gap-3 w-full">
            <div class="bg-white rounded-lg shadow flex flex-col items-center p-2 cursor-pointer transform hover:scale-110 transition-transform duration-200"
                onclick="window.location.href='maritime.html'">
                <span
                    class="material-icons bg-gray-200 rounded-md w-8 h-8 flex items-center justify-center text-gray-700 mb-1 text-base" style="font-size: 1.5em">
                    anchor
                </span>
                <div class="text-xs font-semibold text-gray-600">Maritime</div>
            </div>
            <div class="bg-white rounded-lg shadow flex flex-col items-center p-2 cursor-pointer transform hover:scale-110 transition-transform duration-200"
                onclick="window.location.href='account.html'">
                <span
                    class="material-icons bg-gray-200 rounded-md w-8 h-8 flex items-center justify-center text-gray-700 mb-1 text-base" style="font-size: 1.5em">
                    business_center
                </span>
                <div class="text-xs font-semibold text-gray-600">Finance</div>
            </div>
            <div class="bg-white rounded-lg shadow flex flex-col items-center p-2 cursor-pointer transform hover:scale-110 transition-transform duration-200"
                onclick="window.location.href='academy.html'">
                <span
                    class="material-icons bg-gray-200 rounded-md w-8 h-8 flex items-center justify-center text-gray-700 mb-1 text-base" style="font-size: 1.5em">
                    school
                </span>
                <div class="text-xs font-semibold text-gray-600">Academy</div>
            </div>
            <div class="bg-white rounded-lg shadow flex flex-col items-center p-2 cursor-pointer transform hover:scale-110 transition-transform duration-200"
                onclick="window.location.href='media.html'">
                <span
                    class="material-icons bg-gray-200 rounded-md w-8 h-8 flex items-center justify-center text-gray-700 mb-1 text-base" style="font-size: 1.5em">
                    movie
                </span>
                <div class="text-xs font-semibold text-gray-600">Media</div>
            </div>
            <div class="bg-white rounded-lg shadow flex flex-col items-center p-2 cursor-pointer transform hover:scale-110 transition-transform duration-200"
                onclick="window.location.href='shops.html'">
                <span
                    class="material-icons bg-gray-200 rounded-md w-8 h-8 flex items-center justify-center text-gray-700 mb-1 text-base" style="font-size: 1.5em">
                    store
                </span>
                <div class="text-xs font-semibold text-gray-600">Shop</div>
            </div>
            <div class="bg-white rounded-lg shadow flex flex-col items-center p-2 cursor-pointer transform hover:scale-110 transition-transform duration-200"
                onclick="window.location.href='gamehub.html'">
                <span
                    class="material-icons bg-gray-200 rounded-md w-8 h-8 flex items-center justify-center text-gray-700 mb-1 text-base" style="font-size: 1.5em">
                    sports_esports
                </span>
                <div class="text-xs font-semibold text-gray-600">Games</div>
            </div>
            <div class="bg-white rounded-lg shadow flex flex-col items-center p-2 cursor-pointer transform hover:scale-110 transition-transform duration-200"
                onclick="window.location.href='lottery.html'">
                <span
                    class="material-icons bg-gray-200 rounded-md w-8 h-8 flex items-center justify-center text-gray-700 mb-1 text-base" style="font-size: 1.5em">
                    confirmation_number
                </span>
                <div class="text-xs font-semibold text-gray-600">Lottery</div>
            </div>
            <div class="bg-white rounded-lg shadow flex flex-col items-center p-2 cursor-pointer transform hover:scale-110 transition-transform duration-200"
                onclick="window.location.href='more.html'">
                <span
                    class="material-icons bg-gray-200 rounded-md w-8 h-8 flex items-center justify-center text-gray-700 mb-1 text-base" style="font-size: 1.5em">
                    more_horiz
                </span>
                <div class="text-xs font-semibold text-gray-600">More</div>
            </div>
        </div>

        <!-- Lighter color banner with an icon or image -->
        <a href="lottery.html" class="bg-blue-100 rounded-lg shadow p-4 w-full flex items-center space-x-3 hover:bg-blue-200 transition-colors">
            <img src="assets/images/logo/lotto.png" alt="Panyero Banner Logo" class="w-10 h-10 object-cover rounded-md">
            <div class="flex-1 text-gray-700 text-sm font-medium">
                <strong>â‚±10.00 Wins  â‚±6,500.00!</strong><br>
                Saan aabot ang â‚±10.00 mo?
            </div>
        </a>

        <!-- Transactions list with empty fallback -->
        <div class="bg-white rounded-lg shadow p-4 w-full">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-base font-semibold">Recent Transactions</h3>
                <a href="transactions.html" class="text-primary text-sm hover:underline">See All</a>
            </div>
            <ul id="transactionList" class="space-y-2">
                <!-- If no transactions, fallback displayed -->
                <li class="text-gray-500 text-sm">No recent transactions</li>
            </ul>
        </div>
    </main>

    <!-- Bottom Nav (icons only, QR bigger + elevated) -->
    <div
        class="bg-white border-t border-gray-300 w-full max-w-sm flex justify-around items-center py-2 fixed bottom-0 left-1/2 transform -translate-x-1/2">
        <div class="nav-item cursor-pointer transform hover:scale-110 transition-transform duration-200" onclick="window.location.href='index.html'">
            <span class="material-icons text-gray-600 text-xl" style="font-size: 1.5em">anchor</span>
        </div>
        <div class="nav-item cursor-pointer transform hover:scale-110 transition-transform duration-200" onclick="window.location.href='account.html'">
            <span class="material-icons text-gray-600 text-xl" style="font-size: 1.5em">account_balance_wallet</span>
        </div>
        <div
            class="nav-item qr cursor-pointer transform scale-125 -mt-1 relative hover:scale-130 transition-transform duration-200" onclick="window.location.href='qrscan.html'">
            <span
                class="material-icons text-white text-xl p-2 shadow-md" style="font-size: 1.5em; background-color: var(--primary-color); border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">qr_code_scanner</span>
        </div>
        <div class="nav-item cursor-pointer transform hover:scale-110 transition-transform duration-200" onclick="window.location.href='services.html'">
            <span class="material-icons text-gray-600 text-xl" style="font-size: 1.5em">dns</span>
        </div>
        <div class="nav-item cursor-pointer transform hover:scale-110 transition-transform duration-200" onclick="window.location.href='profile.html'">
            <span class="material-icons text-gray-600 text-xl" style="font-size: 1.5em">person</span>
        </div>
    </div>

    <script>
        let showBalance = true; // default show/hide state
        const logoutBtn = document.getElementById('logoutBtn');
        const balanceAmount = document.getElementById('balanceAmount');
        const transactionList = document.getElementById('transactionList');
        const userName = document.getElementById('userName');
        const userMobile = document.getElementById('userMobile');
        const toggleBalanceBtn = document.getElementById('toggleBalanceBtn');
        const notificationBadge = document.getElementById('notificationBadge');
        let currentBalance = 0;

        // Function to update notification badge
        function updateNotificationBadge(count) {
            if (count > 0) {
                notificationBadge.textContent = count;
                notificationBadge.classList.remove('hidden');
            } else {
                notificationBadge.classList.add('hidden');
            }
        }

        // Function to mark all notifications as read
        async function markNotificationsAsRead(userId) {
            const notificationsRef = db.collection('notifications').where('userId', '==', userId).where('isRead', '==', false);
            const snapshot = await notificationsRef.get();
            snapshot.forEach(doc => {
                db.collection('notifications').doc(doc.id).update({ isRead: true });
            });
        }

        // Handle notification icon click
        async function handleNotificationClick() {
            const user = auth.currentUser;
            if (user) {
                await markNotificationsAsRead(user.uid);
                updateNotificationBadge(0); // Reset badge count
                window.location.href = 'notifications.html';
            }
        }

        // Fetch and display the latest 4 transactions
        async function fetchLatestTransactions(userId) {
            const transactionsRef = db.collection('users').doc(userId).collection('transactions')
                .orderBy('timestamp', 'desc')
                .limit(4);
            const snapshot = await transactionsRef.get();

            transactionList.innerHTML = ''; // Clear existing content

            if (snapshot.empty) {
                transactionList.innerHTML = '<li class="text-gray-500 text-sm">No recent transactions</li>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const li = document.createElement('li');
                li.className = "flex justify-between border-b border-gray-200 pb-1.5";
                li.innerHTML = `
                    <span>${data.type || 'N/A'}</span>
                    <span>â‚±${data.amount || 0}</span>
                `;
                transactionList.appendChild(li);
            });
        }

        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                // Not logged in, redirect
                window.location.href = 'signin.html';
                return;
            }
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
                const data = userDoc.data();
                // Use displayName if available, otherwise construct from firstName and lastName
                const userDisplayName = data.displayName || (data.firstName && data.lastName ? `${data.firstName} ${data.lastName}`.trim() : 'Panyero User');
                userName.textContent = userDisplayName;

                // Map user's phone number
                const userMobileNum = data.phoneNumber || '';
                userMobile.textContent = userMobileNum; // ex. '09171234567'

                currentBalance = data.balance || 0;
                updateBalanceText();

                // Fetch and display the latest 4 transactions
                fetchLatestTransactions(user.uid);

                // Listen for unread notifications
                db.collection('notifications')
                    .where('userId', '==', user.uid)
                    .where('isRead', '==', false)
                    .onSnapshot(snapshot => {
                        updateNotificationBadge(snapshot.size); // Update badge count
                    });
            }
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut()
                .then(() => window.location.href = 'signin.html')
                .catch(err => console.error('Logout error:', err));
        });

        // Toggle function
        function updateBalanceText() {
            if (showBalance) {
                balanceAmount.textContent = `â‚±${currentBalance}`;
                toggleBalanceBtn.textContent = 'visibility';
            } else {
                // Hide it
                let hiddenBal = '****';
                if (String(currentBalance).length > 4) {
                    hiddenBal = '****' + String(currentBalance).slice(-2);
                }
                balanceAmount.textContent = hiddenBal;
                toggleBalanceBtn.textContent = 'visibility_off';
            }
        }

        toggleBalanceBtn.addEventListener('click', () => {
            showBalance = !showBalance;
            updateBalanceText();
        });
    </script>
</body>

</html>

